<% content_for :title do %>
    <% "OpenSplitTime: Administer event - #{@event_stage.name}" %>
<% end %>
<div class="row header">
  <div class="col-xs-5">
    <%= render 'event_info', view_object: @event_stage, title: "Admin #{@event_stage.concealed_text}" %>
  </div>
  <div class="col-xs-7 page-navigation">
    <div class="row">
      <%= link_to_enter_group_live_entry(@event_stage, current_user) %>
      <%= render 'view_buttons', view_object: @event_stage %>
    </div>
    <div class="row">
      <%= link_to_edit_event(@event_stage) %>
      <% if @event_stage.started? %>
          <%= link_to_update_start_time(@event_stage) %>
          <%= link_to_set_data_status(@event_stage) %>
          <% unless @event_stage.available_live %>
              <%= link_to_set_stops(@event_stage) %>
              <%= link_to_ultrasignup_export(@event_stage) %>
          <% end %>
      <% end %>
      <% if current_user&.authorized_fully?(@event_stage.event) %>
          <%= link_to_delete_event(@event_stage) %>
      <% end %>
    </div>
  </div>
</div>

<% if @event_stage.ordered_events_within_group.many? %>
    <div class="row mid">
      <div class="col-xs-5 page-navigation-left">
          <%= render 'event_groups/event_buttons', events: @event_stage.ordered_events_within_group, current_event: @event_stage.event %>
      </div>
    </div>
<% end %>

<%= render 'live_times_list', live_times: @event_stage.filtered_live_times, view_model: @event_stage %>

<script>
    document.addEventListener("turbolinks:load", function () {

        var uID = '<%= session.id %>';
        var pusher = new Pusher('<%= ENV['PUSHER_KEY'] %>');
        var channel = pusher.subscribe('progress_' + uID);
        var firstUpdate = true;

        channel.bind('update', function (data) {
            if (firstUpdate) {
                progressDiv.removeClass('hide');
                firstUpdate = false;
            }
            progressBar.width(data.progress + "%");
            messageBox.html(data.message);
        });

        var progressDiv = $('#progress-bar-with-messages');
        var messageBox = $('#progress-bar-with-messages').children('.progress-bar-title');
        var progressBar = $('#realtime-progress-bar');
    })

</script>
